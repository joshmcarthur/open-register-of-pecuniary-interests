<% content_for :title, "#{@political_entity.name} - Political Entity" %>

<%= render "application/navbar" %>

<div class="container py-12 mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Header Section -->
  <div class="hero min-h-[500px] bg-gradient-to-br from-primary/10 via-base-200 to-secondary/10 rounded-2xl shadow-2xl mb-12">
      <div class="hero-content w-full flex flex-col justify-between h-full">
        <!-- Entity Info -->
        <div class="flex flex-col lg:flex-row items-center justify-between gap-8 w-full flex-1">
          <div class="flex-1 text-center lg:text-left flex-row flex">
            <!-- Profile Image and Name -->
            <div class="flex flex-col lg:flex-row items-center lg:items-start gap-6">
              <% if @political_entity.profile_image.attached? %>
                <div class="avatar">
                  <div class="w-32 h-32 rounded-2xl shadow-lg">
                    <%= image_tag @political_entity.profile_image.variant(:thumbnail),
                        alt: @political_entity.name,
                        class: "rounded-2xl object-cover" %>
                  </div>
                </div>
              <% else %>
                <div class="avatar avatar-placeholder">
                  <div class="bg-neutral text-neutral-content rounded-2xl w-32 h-32 shadow-lg">
                    <span class="text-4xl font-bold">
                      <%= @political_entity.name.first.upcase %>
                    </span>
                  </div>
                </div>
              <% end %>
              <div class="text-center lg:text-left">
                <hgroup>
                  <h1 class="text-5xl font-bold mb-4 text-base-content"><%= @political_entity.name %></h1>
                  <div class="flex flex-wrap gap-1 mt-2">
                    <!-- Jurisdictions -->
                    <% @political_entity.jurisdictions.each do |jurisdiction| %>
                      <% pej = @political_entity.political_entity_jurisdictions.find_by(jurisdiction: jurisdiction) %>
                      <div class="badge badge-primary badge-xl">
                        <%= jurisdiction.name %>
                        <% if pej&.role.present? %>
                          <span class="ml-1 text-xs opacity-75">(<%= pej.role %>)</span>
                        <% end %>
                      </div>
                    <% end %>

                    <!-- Party Affiliations -->
                    <% parties = @political_entity.political_entity_jurisdictions.where.not(affiliation: [nil, ""]).distinct.pluck(:affiliation) %>
                    <% parties.each do |party| %>
                      <div class="badge badge-secondary badge-xl"><%= party %></div>
                    <% end %>
                  </div>
                </hgroup>
                <% if @political_entity.description.present? %>
                  <p class="text-xl text-base-content/80 mb-6 leading-relaxed"><%= @political_entity.description %></p>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Interest Count Summary -->
          <div class="stats stats-vertical sm:stats-horizontal shadow-lg bg-base-100 border border-base-300 rounded-2xl">
            <div class="stat">
              <div class="stat-figure text-primary">
                <%= render 'shared/icons/chart', class: 'inline-block w-8 h-8 stroke-current' %>
              </div>
              <div class="stat-title">Total Interests</div>
              <div class="stat-value text-primary"><%= @political_entity.interests.count %></div>
              <div class="stat-desc">Declared interests</div>
            </div>
            <div class="stat">
              <div class="stat-figure text-secondary">
                <%= render 'shared/icons/building', class: 'inline-block w-8 h-8 stroke-current' %>
              </div>
              <div class="stat-title">Categories</div>
              <div class="stat-value text-secondary"><%= @interest_categories.count %></div>
              <div class="stat-desc">Interest types</div>
            </div>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div class="mt-8">
          <h3 class="text-lg font-semibold text-center mb-4 text-base-content">Browse Interests by Category</h3>
          <div class="tabs tabs-boxed bg-base-100/80 backdrop-blur-sm border border-base-300 rounded-2xl p-4 shadow-lg justify-center">
            <%= link_to political_entity_path(@political_entity, tab: 'all'),
                class: "tab #{'tab-active' if @active_tab == 'all'} font-semibold" do %>
              All Interests
              <span class="badge badge-sm ml-2 #{'badge-primary' if @active_tab == 'all'} #{'badge-outline' unless @active_tab == 'all'}"><%= @political_entity.interests.count %></span>
            <% end %>

            <% @interest_categories.each do |category| %>
              <% category_count = @political_entity.interests.joins(:interest_category).where(interest_categories: { key: category.key }).count %>
              <%= link_to political_entity_path(@political_entity, tab: category.key),
                  class: "tab #{'tab-active' if @active_tab == category.key}" do %>
                <%= category.label %>
                <span class="badge badge-sm ml-2 #{'badge-primary' if @active_tab == category.key} #{'badge-outline' unless @active_tab == category.key}"><%= category_count %></span>
              <% end %>
            <% end %>
          </div>
        </div>
    </div>
  </div>

  <!-- Interests Content -->
  <div class="space-y-6">
    <% if @interests.any? %>
      <% if @active_tab == 'all' %>
        <!-- Group by category when showing all -->
        <% @interests.group_by(&:interest_category).each do |category, interests| %>
          <div class="card bg-base-100 shadow-xl border border-base-300">
            <div class="card-body">
              <h2 class="card-title text-2xl mb-6">
                <%= category.label %>
                <span class="badge badge-primary badge-lg"><%= interests.count %></span>
              </h2>

              <div class="grid gap-4">
                <% interests.each do |interest| %>
                  <div class="card bg-base-100 shadow-sm border border-base-300 hover:shadow-md transition-shadow">
                    <div class="card-body p-6">
                      <!-- Main content -->
                      <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                          <p class="text-lg leading-relaxed text-base-content font-medium"><%= interest.description %></p>
                        </div>
                        <div class="dropdown dropdown-end ml-4">
                          <div tabindex="0" role="button" class="btn btn-ghost btn-sm btn-circle">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-5 h-5 stroke-current">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01"></path>
                            </svg>
                          </div>
                          <ul tabindex="0" class="dropdown-content z-[1] menu p-3 shadow-lg bg-base-100 rounded-box w-64 border border-base-300">
                            <li class="menu-title">
                              <span>Source Information</span>
                            </li>
                            <li><span class="text-sm">Source: <%= interest.source.name %></span></li>
                            <% if interest.source_page_numbers&.any? %>
                              <li><span class="text-sm">(page <%= interest.source_page_numbers.to_sentence %>)</span></li>
                            <% end %>
                            <li><span class="text-sm">Jurisdiction: <%= interest.jurisdiction.name %></span></li>
                            <% if interest.metadata.present? && interest.metadata.any? %>
                              <li class="menu-title">
                                <span>Additional Data</span>
                              </li>
                              <% interest.metadata.each do |key, value| %>
                                <li><span class="text-sm"><%= key.humanize %>: <%= value %></span></li>
                              <% end %>
                            <% end %>
                          </ul>
                        </div>
                      </div>

                      <!-- Source and metadata info -->
                      <div class="flex flex-wrap gap-2">
                        <%= render "interests/source", interest: interest %>

                        <% if interest.metadata.present? && interest.metadata.any? %>
                          <div class="badge badge-accent badge-sm">
                            Additional Data
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <!-- Show interests for specific category -->
        <div class="card bg-base-100 shadow-xl border border-base-300">
          <div class="card-body">
            <h2 class="card-title text-2xl mb-6">
              <%= @interest_categories.find { |c| c.key == @active_tab }&.label || @active_tab.humanize %>
              <span class="badge badge-primary badge-lg"><%= @interests.count %></span>
            </h2>

            <div class="grid gap-4">
              <% @interests.each do |interest| %>
                <div class="card bg-base-100 shadow-sm border border-base-300 hover:shadow-md transition-shadow">
                  <div class="card-body p-6">
                    <!-- Main content -->
                    <div class="flex justify-between items-start mb-4">
                      <div class="flex-1">
                        <p class="text-lg leading-relaxed text-base-content font-medium"><%= interest.description %></p>
                      </div>
                      <div class="dropdown dropdown-end ml-4">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-sm btn-circle">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-5 h-5 stroke-current">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01"></path>
                          </svg>
                        </div>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-3 shadow-lg bg-base-100 rounded-box w-64 border border-base-300">
                          <li class="menu-title">
                            <span>Source Information</span>
                          </li>
                          <li><span class="text-sm">
                            Source: <%= interest.source.name %>
                             <% if interest.source.year.present? && interest.source.name.exclude?(interest.source.year.to_s) %>
                              (<%= interest.source.year %>)
                            <% end %>
                            <% if interest.source_page_numbers&.any? %>
                              (page <%= interest.source_page_numbers.to_sentence %>)
                            <% end %>
                          </span>
                          </li>
                          <li><span class="text-sm">Jurisdiction: <%= interest.jurisdiction.name %></span></li>
                          <% if interest.metadata.present? && interest.metadata.any? %>
                            <li class="menu-title">
                              <span>Additional Data</span>
                            </li>
                            <% interest.metadata.each do |key, value| %>
                              <li><span class="text-sm"><%= key.humanize %>: <%= value %></span></li>
                            <% end %>
                          <% end %>
                        </ul>
                      </div>
                    </div>

                    <!-- Source and metadata info -->
                    <div class="flex flex-wrap gap-2">
                      <div class="badge badge-primary badge-sm">
                        <%= interest.source.name %>
                        <% if interest.source.year.present? && interest.source.name.exclude?(interest.source.year.to_s) %>
                          (<%= interest.source.year %>)
                        <% end %>
                        <% if interest.source_page_numbers&.any? %>
                          (page <%= interest.source_page_numbers.to_sentence %>)
                        <% end %>
                      </div>
                      <% if interest.metadata.present? && interest.metadata.any? %>
                        <div class="badge badge-accent badge-sm">
                          Additional Data
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <!-- No interests found -->
      <div class="card bg-base-100 shadow-xl border border-base-300">
        <div class="card-body text-center py-12">
          <h2 class="card-title justify-center text-2xl mb-4">
            <% if @active_tab == 'all' %>
              No Interests Found
            <% else %>
              No Interests in This Category
            <% end %>
          </h2>
          <p class="text-base-content/70 mb-6 text-lg">
            <% if @active_tab == 'all' %>
              This political entity has no recorded interests.
            <% else %>
              This political entity has no interests in the selected category.
            <% end %>
          </p>
          <% if @active_tab != 'all' %>
            <%= link_to "View All Interests", political_entity_path(@political_entity, tab: 'all'),
                class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Data Sources Section -->
  <div class="mt-12">
    <div class="card bg-base-100 shadow-xl border border-base-300">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-6 h-6 stroke-current">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Data Sources & Attribution
        </h2>

        <div class="space-y-4">
          <!-- Profile Image Attribution -->
          <% if @political_entity.profile_image.attached? %>
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 p-4 bg-base-200 rounded-lg">
              <div class="flex items-center gap-3">
                <div class="avatar">
                  <div class="w-12 h-12 rounded-lg">
                    <%= image_tag @political_entity.profile_image.variant(:small),
                        alt: @political_entity.name,
                        class: "rounded-lg object-cover" %>
                  </div>
                </div>
                <div>
                  <div class="font-semibold">Profile Image</div>
                  <div class="text-sm text-base-content/70">
                    Source: Wikimedia Commons
                  </div>
                </div>
              </div>
              <div class="flex flex-wrap gap-2 sm:ml-auto">
                <% if @political_entity.profile_image.metadata[:wikipedia_page_url]  %>
                  <%= link_to @political_entity.profile_image.metadata[:wikipedia_page_url],
                      target: "_blank",
                      class: "btn btn-sm btn-outline btn-primary" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-4 h-4 stroke-current">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    Wikipedia Page
                  <% end %>
                <% end %>
                <% if @political_entity.profile_image.metadata[:wikimedia_url] %>
                  <%= link_to @political_entity.profile_image.metadata[:wikimedia_url],
                      target: "_blank",
                      class: "btn btn-sm btn-outline btn-secondary" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-4 h-4 stroke-current">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Original Image
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Interest Data Sources -->
          <% if @political_entity.interests.any? %>
            <div class="p-4 bg-base-200 rounded-lg">
              <div class="font-semibold mb-2">Interest Declarations</div>
              <div class="text-sm text-base-content/70 mb-3">
                The following sources were used to compile interest declaration data:
              </div>
              <div class="flex flex-wrap gap-2">
                <% @political_entity.interests.joins(:source).group(:source_id, :source_page_numbers).each do |interest| %>
                  <%= render "interests/source", interest: interest %>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- General Attribution -->
          <div class="p-4 bg-base-200 rounded-lg">
            <div class="font-semibold mb-2">Attribution</div>
            <div class="text-sm text-base-content/70 space-y-2">
              <p>
                Profile images are sourced from Wikimedia Commons and are used under their respective
                <a href="https://commons.wikimedia.org/wiki/Commons:Licensing" target="_blank" class="link link-hover">licensing terms</a>.
                All images are freely licensed for use.
              </p>
              <p>
                Interest declaration data is compiled from official government sources and public records.
                For the most current and complete information, please refer to the original sources.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Actions -->
  <div class="flex justify-end mt-12">
    <div class="btn-group">
      <%= link_to "Export this data as CSV", export_political_entity_path(@political_entity),
          class: "btn btn-primary" %>
    </div>
  </div>

  <%= render "application/data_source_information" %>
</div>